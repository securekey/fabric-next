From a3fdeeea6d8290a25250af1b6c478d8beac33eb6 Mon Sep 17 00:00:00 2001
From: Firas Qutishat <firas.qutishat@securekey.com>
Date: Fri, 15 Feb 2019 21:37:01 -0500
Subject: [PATCH] Fix ccenv image

Change-Id: I319fa2fa86a5c2a21f8ee5f859c108b8d0ee45f7
Signed-off-by: Firas Qutishat <firas.qutishat@securekey.com>
---
 Makefile                   | 2 +-
 images/ccenv/Dockerfile.in | 2 ++
 scripts/goListFiles.sh     | 1 +
 3 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/Makefile b/Makefile
index f29a46be..39f5f664 100755
--- a/Makefile
+++ b/Makefile
@@ -89,7 +89,7 @@ EXECUTABLES ?= go docker git curl
 K := $(foreach exec,$(EXECUTABLES),\
 	$(if $(shell which $(exec)),some string,$(error "No $(exec) in PATH: Check dependencies")))
 
-GOSHIM_DEPS = $(shell ./scripts/goListFiles.sh $(PKGNAME)/core/chaincode/shim)
+GOSHIM_DEPS = $(shell rm go.sum;./scripts/goListFiles.sh $(PKGNAME)/core/chaincode/shim)
 PROTOS = $(shell git ls-files *.proto | grep -Ev 'vendor/|testdata/')
 # No sense rebuilding when non production code is changed
 PROJECT_FILES = $(shell git ls-files  | grep -v ^test | grep -v ^unit-test | \
diff --git a/images/ccenv/Dockerfile.in b/images/ccenv/Dockerfile.in
index 6d032872..0d22ade6 100644
--- a/images/ccenv/Dockerfile.in
+++ b/images/ccenv/Dockerfile.in
@@ -5,4 +5,6 @@
 FROM _BASE_NS_/fabric-baseimage:_BASE_TAG_
 COPY payload/chaintool payload/protoc-gen-go /usr/local/bin/
 ADD payload/goshim.tar.bz2 $GOPATH/src/
+RUN ls -l $GOPATH/src/github.com/hyperledger/fabric
+RUN cd $GOPATH/src/github.com/hyperledger/fabric;GOCACHE=on GO111MODULE=on go mod vendor
 RUN mkdir -p /chaincode/input /chaincode/output
diff --git a/scripts/goListFiles.sh b/scripts/goListFiles.sh
index 18d10c0e..966b61ba 100755
--- a/scripts/goListFiles.sh
+++ b/scripts/goListFiles.sh
@@ -28,3 +28,4 @@ list_deps() {
 }
 
 list_deps $1 | sort | uniq
+echo $GOPATH/src/github.com/hyperledger/fabric/go.mod
-- 
2.17.2 (Apple Git-113)

